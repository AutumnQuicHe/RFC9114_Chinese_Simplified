---
title: "5.2. 连接的正常关闭"
anchor: "5.2_Connection_Shutdown"
weight: 50200
rank: "h2"
---

即使连接并不处于空闲状态，任一终端也可以决定要不要停止使用该连接，然后发起一次优雅的连接关闭。
终端以发送**关闭帧**的形式对HTTP/3连接发起优雅关闭。
**关闭帧**包含着一个标识符，它向接收方表明在此连接中已经或可能得到处理的请求或推送的数量。
服务器发送的是某个由客户端创建的双向流ID；客户端发送的是某个推送ID。
ID大于等于该标识符的请求或推送都会被**关闭帧**的发送方拒绝（详见[第4.1.1章]()）。
如果没有处理过任何请求或推送，那么该标识符**可以**为零。

**关闭帧**中的信息使得客户端和服务器在HTTP/3连接被关闭前就接受了哪些请求或推送达成共识。
为了清理受影响的流的传输层状态，一旦发送了**关闭帧**，终端就**应该**主动取消（详见[第4.1.1章]()和[第7.2.3章]()）所有ID大于等于该帧中的标识符的请求或推送。
哪怕之后抵达了新的请求或推送，终端也**应该**重复这种操作。

终端在从对端接收到**关闭帧**后，**必须不**在该连接上发起新的请求或承诺新的推送。
客户端**可以**建立新的连接来将额外的请求发送出去。

某些请求或推送可能已经处于传输状态：

* 在接收到**关闭帧**时，如果客户端已经将流ID大于等于**关闭帧**中的标识符的请求发送出去了，那么这些请求将不会得到处理。
客户端可以在另一条HTTP连接上安全地重发得不到处理的请求。
没有能力重发请求的客户端则会在服务器关闭连接时丢失所有在途的请求。

  如果请求所在的流ID小于来自服务器的**关闭帧**中的标识符，那么它可能会得到处理；除非客户端接收到响应、流被单独重置、接收到另一个标识符更小的**关闭帧**或连接被终止，否则无从得知它们的状态。

  服务器**可以**拒绝ID小于标识符的流上的单个请求，只要不去处理这类请求。

* 如果服务器接收到了**关闭帧**，但它已经承诺了ID大于等于**关闭帧**中的标识符的推送，那么这些推送不会被接受。

服务器**应该**在提前知晓了连接即将关闭的信息时就发送**关闭帧**，哪怕该提前通知微不足道，以使得对端能够知道某个请求有没有得到处理。
例如，如果某HTTP客户端在服务器关闭QUIC连接的时候刚好发送了一个`POST`请求，那么客户端就无从得知服务器是否处理了该POST请求，除非服务器发送一个**关闭帧**来表明它的处理进度。

终端**可以**多次发送**关闭帧**，并使用不同的标识符，但是每个帧中的标识符都**必须不**大于先前发送的帧中的标识符，因为客户端可能已经在另一条HTTP连接上重发了得不到处理的请求。
如果终端接收到的**关闭帧**中的标识符大于先前所接收到的，那么**必须**将该情况视作类型为`H3_ID_ERROR`（ID错误）的连接错误。

正在尝试优雅关闭某条连接的终端可以发送一个标识符的值为最大允许值（对于服务器，这个值为<code>2<sup>62</sup>-4</code>；对于客户端则为<code>2<sup>62</sup>-1</code>）的**关闭帧**。
这能确保对端不再创建新的请求或推送。
在经过一段足够在途请求或推送抵达的时间后，终端可以再发送一个**关闭帧**，表明它在连接关闭前所接受的那个请求或推送。
这确保了一条连接能够被干净地关闭，而不丢失请求。

客户端在选择其发送的**关闭帧**的推送ID字段的值时，有着更多的自由。
值<code>2<sup>62</sup>-1</code>表示服务器可以继续兑现已经承诺的推送。
而小一点的值则表示客户端将拒绝ID大于等于该值的推送。
就像服务器一样，只要使用的推送ID值不超过之前发送过的值，那么客户端就**可以**连续发送**关闭帧**。

即便**关闭帧**表明了某些请求或推送不会在接收时得到处理或接受，但经过底层传输的资源仍然存在于接收方。
为了清理传输层状态，发起这些请求的终端可以取消它们。

一旦处理完所有已接受的请求和推送，终端就能批准连接进入空闲状态，或它**可以**对此连接发起即刻关闭。
完成了优雅关闭的终端**应该**在关闭连接时使用错误码`H3_NO_ERROR`（无错误）。

如果客户端已经为请求消耗完所有可用的双向流ID，那么服务器就不需要再发送**关闭帧**，因为客户端已经无法再发送更多请求。
